```{r libraries}
library(sf) # simple features packages for handling vector GIS data
library(httr) # generic webservice package
library(tidyverse) # a suite of packages for data wrangling, transformation, plotting, ...
library(ows4R) # interface for OGC webservices
```

```{r get provinces}
wfs_prov <- "https://eservices.minfin.fgov.be/arcgis/services/R2C/Provinces/MapServer/WFSServer"

regions_client <- WFSClient$new(wfs_prov, 
                            serviceVersion = "2.0.0")
regions_client$getFeatureTypes(pretty = TRUE)


url <- parse_url(wfs_prov)
url$query <- list(service = "wfs",
                  #version = "2.0.0", # optional
                  request = "GetFeature",
                  typename = "Provinces",
                  srsName = "EPSG:4326"
                  )
request <- build_url(url)

prov <- read_sf(request) 

prov_recalc <- prov %>% 
  mutate(GEWEST = case_when(AdReKey == 2000 ~ "flanders",
                            AdReKey == 3000 ~ "wallonia",
                            AdReKey == 4000 ~ "brussels"),
         NAAM = substr(x = NameDUT, start = 10, stop = nchar(NameDUT))) %>% 
  dplyr::select(NISCODE = AdPrKey,
                NAAM,
                GEWEST)


  prov_recalc$NAAM <- str_replace_all(string = prov_recalc$NAAM, pattern = fixed(" "), replacement = "")
  
write_sf(prov_recalc, "./data/spatial/provinces.geojson")
```

```{r test prov, eval = FALSE}
library(leaflet)

prov_recalc %>% 
  filter(NISCODE == 20001) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons()
```

```{r get communes}
wfs_mun <- "https://eservices.minfin.fgov.be/arcgis/services/R2C/Municipalities/MapServer/WFSServer"

mun_client <- WFSClient$new(wfs_mun, 
                            serviceVersion = "2.0.0")
mun_client$getFeatureTypes(pretty = TRUE)


url <- parse_url(wfs_mun)
url$query <- list(service = "wfs",
                  #version = "2.0.0", # optional
                  request = "GetFeature",
                  typename = "Municipalities",
                  srsName = "EPSG:4326"
                  )
request <- build_url(url)

mun <- read_sf(request) 

prov_recalc <- prov %>% 
  mutate(GEWEST = case_when(AdReKey == 2000 ~ "flanders",
                            AdReKey == 3000 ~ "wallonia",
                            AdReKey == 4000 ~ "brussels"),
         NAAM = substr(x = NameDUT, start = 10, stop = nchar(NameDUT))) %>% 
  dplyr::select(NISCODE = AdPrKey,
                NAAM,
                GEWEST)


  prov_recalc$NAAM <- str_replace_all(string = prov_recalc$NAAM, pattern = fixed(" "), replacement = "")
  
write_sf(prov_recalc, "./data/spatial/provinces.geojson")
```

