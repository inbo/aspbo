---
title: "build_queries"
author: "Sander Devisscher"
date: "2024-10-17"
output: html_document
---

A script to download the occurrence cube from the GBIF API.

```{r libraries}
library(tidyverse)
```

```{r get griis checklist}
# Get the griis checklist
griis_checklist <- read_delim("data/output/UAT_processing/data_input_checklist_indicators.tsv", 
                              delim = "\t", escape_double = FALSE, 
                              trim_ws = TRUE) %>% 
  distinct(nubKey, rank)

# Split into dataframes based on rank
griis_checklist_split <- split(griis_checklist, griis_checklist$rank)
```

```{r download rank cubes}
# extract ranks list
ranks <- unique(griis_checklist$rank)

# Combine form, subspecies en variety
ranks <- ranks[!ranks %in% c("FORM", "SUBSPECIES", "VARIETY")]
ranks <- c(ranks, "SUBSPECIES_FORM_VARIETY")

# loop over ranks
for(rank in ranks){
  
  # print rank
  print(rank)
  
  # get nubKeys for the rank
  nubKey_list <- griis_checklist_split[[rank]]$nubKey
  
  # get query file
  query_file <- paste0("data/input/griis_belgium_", tolower(rank), "_base.txt")
  if(file.exists(query_file)){
    query <- gsub(pattern = "  ", replacement = "", paste0(readLines(query_file), collapse = " "))
  }else{
    warning(paste0(rank, " query file does not exist"))
    next #for testing purposes
  }
  
  # add nubkeys to query
  query <- gsub(pattern = "<--nubkeys-->", replacement = paste0(nubKey_list, " ", collapse = ","), query)
  
  # export query
  writeLines(query, paste0("data/interim/cube_queries/griis_belgium_", tolower(rank), "_query.txt"))
}
```

